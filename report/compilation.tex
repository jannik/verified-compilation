\documentclass[12pt]{article}
\usepackage[english]{babel}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{stmaryrd}
\usepackage{mathtools}
\usepackage{bussproofs}
\usepackage{ntheorem}

\newcommand{\alt}{\;\; | \;\;}
\newcommand{\defi}{\Coloneqq}
\newcommand{\nil}{\cdot}
\newcommand{\h}[1]{\hat{#1}}
\newcommand{\set}[1]{\{#1\}}
\renewcommand{\rule}{\textsc}
\newcommand{\sg}{\sigma}
\renewcommand{\phi}{\varphi}
\newcommand{\De}{\Delta}
\newcommand{\E}{\mathcal{E}}
\newcommand{\B}{\mathcal{B}}
\newcommand{\Bv}{\mathcal{B}^{\mathrm{v}}}
\newcommand{\C}{\mathcal{C}}
\newcommand{\D}{\mathcal{D}}
\newcommand{\T}{\mathcal{T}}
\newcommand{\Tv}{\mathcal{T}^{\mathrm{v}}}
\renewcommand{\P}{\mathcal{P}}
\newcommand{\z}{\mathtt{z}}
\newcommand{\suc}{\mathtt{s} \;}
\newcommand{\dom}{\mathsf{dom}}

\newcommand{\n}[1]{\overline{#1}}
\newcommand{\lam}[2]{\lambda #1. #2}
\newcommand{\app}{\;}
\newcommand{\cl}[2]{\langle #1, #2 \rangle}
\newcommand{\sub}[3]{#1[#2/#3]}
\newcommand{\subs}[2]{#1[#2]}
\newcommand{\wo}{\backslash}
\newcommand{\sapp}{\mathtt{app}}

\newcommand{\judgement}[1]{\framebox{#1}}
\newcommand{\ninf}[1]{\AxiomC{#1}}
\newcommand{\uinf}[1]{\UnaryInfC{#1}}
\newcommand{\binf}[1]{\BinaryInfC{#1}}
\newcommand{\tinf}[1]{\TrinaryInfC{#1}}
\newcommand{\ax}[1]{\ninf{} \uinf{#1}}
\newcommand{\prem}[2]{\noLine \ninf{$#1$} \uinf{#2}}
\newcommand{\leftl}[1]{\LeftLabel{#1\;}}
\newcommand{\rightl}[1]{\RightLabel{#1}}

\newcommand{\tr}[2]{\ensuremath{#1 \rhd #2}}
\newcommand{\tra}[3]{\ensuremath{#1 \vdash #2 \rhd #3}}
\newcommand{\trav}[3]{\ensuremath{#1 \vdash #2 \rhd^{\mathrm{v}} #3}}
\newcommand{\ev}[2]{\ensuremath{#1 \downarrow #2}}
\newcommand{\hev}[3]{\ensuremath{#1 \vdash #2 \Downarrow #3}}
\newcommand{\hevv}[3]{\ensuremath{#1 \vdash #2 \Downarrow^{\mathrm{v}} #3}}
\newcommand{\sev}[4]{\ensuremath{\langle #1; #2 \rangle \rightarrow \langle #3; #4 \rangle}}
\newcommand{\ssev}[4]{\ensuremath{\langle #1; #2 \rangle \rightarrow^* \langle #3; #4 \rangle}}
\newcommand{\sevv}[3]{\ensuremath{#1 \vdash #2 \downarrow^{\mathrm{v}} #3}}
\newcommand{\fr}[2]{\langle #1; #2 \rangle}
\newcommand{\eqv}[3]{\ensuremath{#1 \downarrow #2 \sim #3}}
\newcommand{\cor}[2]{\ensuremath{#1 \rightsquigarrow #2}}
\newcommand{\comp}[3]{\ensuremath{#1 \stackrel{#2}{\rightsquigarrow} #3}}
\newcommand{\scomp}{\cor}

% hopefully temporary:
\newcommand{\e}{e} % hoas expressions, previously 'e'
\renewcommand{\c}{c} % canonical forms, previously 'v'
\renewcommand{\b}{b} % de bruijn expressions, previously '\h{\e}'
\renewcommand{\v}{v} % values, previously '\h{v}'
\newcommand{\s}{s}
\renewcommand{\ss}{p} % previously '\s^*'
\newcommand{\w}{w}


\newcounter{statementcounter}
\newtheorem{lemma}[statementcounter]{Lemma}
\newtheorem{theorem}[statementcounter]{Theorem}

\newenvironment{proof}[1][Proof]{
\paragraph{#1}
}{
\begin{flushright}
$\blacksquare$
\end{flushright}
}

\begin{document}

\subsection*{Syntax}

\begin{align*}
  % x &\in \mathsf{vars} \quad (\text{variable identifiers}) \\
  e &\defi \n{n} \alt x \alt \lam{x}{\e_1} \alt \e_1 \app \e_2 \\
  \c &\defi \n{n} \alt \lam{x}{\e} \quad (\text{with} \; FV(\e) \subseteq \set{x}) \\
	\\
	i &\defi \z \alt \suc i \\
	\b &\defi \n{n} \alt i \alt \lam{}{\b_1} \alt \b_1 \app \b_2 \\
  \v &\defi \n{n} \alt \cl{\sg}{\b}
\end{align*}
Let $\sg$ and $\De$ denote ordered lists (with possible repetitions) as follows:
\begin{align*}
  \sg &\defi \nil \alt \sg, \v \\
	\Delta &\defi \nil \alt \De, x
\end{align*}

\subsection*{Translation}

\judgement{\tra{\De}{\e}{\b}}

\begin{prooftree}
  \leftl{\rule{T-Num} :}
  \ax{\tra{\De}{\n{n}}{\n{n}}}
\end{prooftree}

\begin{prooftree}
  \ninf{\trav{\De}{x}{i}}
  \leftl{\rule{T-Var} :}
  \uinf{\tra{\De}{x}{i}}
\end{prooftree}

\begin{prooftree}
	\ninf{\tra{\De, x}{\e_1}{\b_1}}
  \leftl{\rule{T-Lam} :}
  \uinf{\tra{\De}{\lam{x}{\e_1}}{\lam{}{\b_1}}}
\end{prooftree}

\begin{prooftree}
  \ninf{\tra{\De}{\e_1}{\b_1}}
  \ninf{\tra{\De}{\e_2}{\b_2}}
	\leftl{\rule{T-App} :}
  \binf{\tra{\De}{\e_1 \app \e_2}{\b_1 \app \b_2}}
\end{prooftree}

\noindent \judgement{\trav{\De}{x}{i}}

\begin{prooftree}
  \leftl{\rule{Tv-Here} :}
  \ax{\trav{\De, x}{x}{\z}}
\end{prooftree}

\begin{prooftree}
  \ninf{\trav{\De}{x}{i}}
  \leftl{\rule{Tv-There} :}
	\rightl{$(x \neq y)$}
  \uinf{\trav{\De, y}{x}{\suc i}}
\end{prooftree}

\subsection*{Semantics}

\judgement{\ev{\e}{\c}} ($\e$ closed)

\begin{prooftree}
  \leftl{\rule{E-Num} :}
  \ax{\ev{\n{n}}{\n{n}}}
\end{prooftree}

\begin{prooftree}
  \leftl{\rule{E-Lam} :}
  \ax{\ev{\lam{x}{\e_1}}{\lam{x}{\e_1}}}
\end{prooftree}

\begin{prooftree}
  \ninf{\ev{\e_1}{\lam{x}{\e_0}}}
  \ninf{\ev{\e_2}{\c_2}}
  \ninf{\ev{\sub{\e_0}{\c_2}{x}}{\c}}
	\leftl{\rule{E-App} :}
  \tinf{\ev{\e_1 \app \e_2}{\c}}
\end{prooftree}

\noindent \judgement{\hev{\sg}{\b}{\v}}

\begin{prooftree}
  \leftl{\rule{B-Num} :}
  \ax{\hev{\sg}{\n{n}}{\n{n}}}
\end{prooftree}

\begin{prooftree}
  \ninf{\hevv{\sg}{i}{\v}}
  \leftl{\rule{B-Var} :}
  \uinf{\hev{\sg}{i}{\v}}
\end{prooftree}

\begin{prooftree}
  \leftl{\rule{B-Lam :}}
  \ax{\hev{\sg}{\lam{}{\b_1}}{\cl{\sg}{\b_1}}}
\end{prooftree}

\begin{prooftree}
  \ninf{\hev{\sg}{\b_1}{\cl{\sg'}{\b_0}}}
  \ninf{\hev{\sg}{\b_2}{\v_2}}
  \ninf{\hev{\sg', \v_2}{\b_0}{\v}}
	\leftl{\rule{B-App} :}
  \tinf{\hev{\sg}{\b_1 \app \b_2}{\v}}
\end{prooftree}

\noindent \judgement{\hevv{\sg}{i}{\v}}

\begin{prooftree}
  \leftl{\rule{Bv-Here} :}
  \ax{\hevv{\sg, \v}{\z}{\v}}
\end{prooftree}

\begin{prooftree}
  \ninf{\hevv{\sg}{i}{\v}}
  \leftl{\rule{Bv-There} :}
  \uinf{\hevv{\sg, \v'}{\suc i}{\v}}
\end{prooftree}

\subsection*{Main Theorem}

\begin{theorem}[Soundness]
\label{thm:soundness} If \tra{\nil}{\e}{\b}, then \ev{\e}{\n{n}} if and only if \hev{\nil}{\b}{\n{n}}.
\end{theorem}

We will now develop the machinery necessary to prove this.

\subsubsection*{Correspondence}

Let $\phi$ denote finite partial maps from variable names to canonical forms.
Let $\subs{\e}{\phi}$ denote $\sub{\sub{\e}{\phi(x_1)}{x_1} \ldots}{\phi(x_n)}{x_n}$, where $\set{x_1, ..., x_n}$ is the domain of $\phi$.
Note that, since each $\phi(x_i)$ is closed, the substitution order does not matter.
Also, let $\phi \wo x$ denote $\phi$ with its domain restricted to $\dom(\phi) \wo \set{x}$.
We first define a notion of correspondence between values and canonical forms: \\

\noindent \judgement{\cor{\v}{\c}}

\begin{prooftree}
  \leftl{\rule{C-Num} :}
  \ax{\cor{\n{n}}{\n{n}}}
\end{prooftree}

\begin{prooftree}
  \ninf{\comp{\sg}{\De}{\phi}}
  \ninf{\tra{\De, x}{\e}{\b}}
  \leftl{\rule{C-Fun} :}
  \binf{\cor{\cl{\sg}{\b}}{\lam{x}{\subs{\e}{\phi \wo x}}}}
\end{prooftree}

\noindent \judgement{\comp{\sg}{\De}{\phi}}

\begin{prooftree}
  \leftl{\rule{D-Nil} :}
  \ax{\comp{\nil}{\nil}{\nil}}
\end{prooftree}

\begin{prooftree}
  \ninf{\comp{\sg}{\De}{\phi}}
  \ninf{\cor{\v}{\c}}
  \leftl{\rule{D-Cons} :}
  \binf{\comp{\sg, \v}{\De, x}{\phi[x \mapsto \c]}}
\end{prooftree}

\begin{lemma}[Evaluation of Values]
\label{lem:value-eval}
For all $\c$, \ev{\c}{\c}.
\end{lemma}

\begin{lemma}[Determinism]
\label{lem:determ}
If \ev{\e}{\c} and \ev{\e}{c'}, then $\c = \c'$.
\end{lemma}

\begin{lemma}
\label{lem:left-to-right-var}
If \trav{\De}{x}{i} (by $\Tv$) and \comp{\sg}{\De}{\phi} (by $\D$), then there exists $\v$ such that \hevv{\sg}{i}{\v} (by some $\Bv$), $x \in \dom(\phi)$ and \cor{\v}{\phi(x)} (by some $\C$).
\end{lemma}

\begin{proof}
By induction on $\Tv$.

\paragraph{Case \textnormal{\rule{Tv-Here}}}

\begin{prooftree}
  \leftl{$\Tv =$}
  \ax{\trav{\De', x}{x}{\z}}
\end{prooftree}
So $\De = \De', x$ and $i = \z$.
Then $\D$ must have the form
\begin{prooftree}
  \prem{\D_1}{\comp{\sg'}{\De'}{\phi'}}
  \prem{\C'}{\cor{\v}{\c}}
  \binf{\comp{\sg', \v}{\De', x}{\phi'[x \mapsto \c]}}
\end{prooftree}
So $\sg = \sg', \v$ and $\phi = \phi'[x \mapsto \c]$.
We now get the required derivation $\Bv$ of $\hevv{\sg', \v}{\z}{\v}$ directly by rule \rule{Bv-Here}.
And since $\phi(x) = \phi'[x \mapsto \c](x) = \c$, we can take $\C = \C'$.

\paragraph{Case \textnormal{\rule{Tv-There}}}

\begin{prooftree}
  \prem{\Tv_1}{\trav{\De}{x}{i'}}
  \leftl{$\Tv =$}
	\rightl{$(x \neq y)$}
  \uinf{\trav{\De', y}{x}{\suc i'}}
\end{prooftree}
So $\De = \De', y$ and $i = \suc i'$.
Then $\D$ must have the form
\begin{prooftree}
  \prem{\D_1}{\comp{\sg'}{\De'}{\phi'}}
  \prem{\C'}{\cor{\v'}{\c'}}
  \binf{\comp{\sg', \v'}{\De', y}{\phi'[y \mapsto \c']}}
\end{prooftree}
So $\sg = \sg', \v'$ and $\phi = \phi'[y \mapsto \c']$.

Now by IH on $\Tv_1$ with $\D_1$, we get derivations $\Bv_1$ of $\hevv{\sg'}{i'}{\v}$ and $\C_1$ of $\cor{\v}{\phi'(x)}$.
We construct the required derivation $\Bv$ as follows:
\begin{prooftree}
  \prem{\Bv_1}{\hevv{\sg'}{i'}{\v}}
  \uinf{\hevv{\sg', \v'}{\suc i'}{\v}}
\end{prooftree}
And since $\phi(x) = \phi'[y \mapsto \c'](x) = \phi'(x)$ (because $x \neq y$), we can take $\C = \C_1$.

\end{proof}

\begin{lemma}
\label{lem:left-to-right}
If \tra{\De}{\e}{\b} (by $\T$), \ev{\subs{\e}{\phi}}{\c} (by $\E$) and \comp{\sg}{\De}{\phi} (by $\D$), then there exists $\v$ such that \hev{\sg}{\b}{\v} (by some $\B$) and \cor{\v}{\c} (by some $\C$).
\end{lemma}

\begin{proof}
By induction on $\E$. We proceed by case analysis on $\e$.

\paragraph{Case $\e = \n{n}$}

$\T$ must end in \rule{T-Num} and so $\b = \n{n}$.
We have $\subs{\e}{\phi} = \n{n}$, so $\E$ must end in \rule{E-Num} and $v = \n{n}$.
Taking $\v = \n{n}$, by rule \rule{B-Num} we get a derivation $\B$ of $\hev{\sg}{\n{n}}{\n{n}}$ as required.
And $\cor{\n{n}}{\n{n}}$ by rule \rule{C-Num}.

\paragraph{Case $\e = x$}

$\T$ must have the form
\begin{prooftree}
  \prem{\Tv}{\trav{\De}{x}{i}}
  \uinf{\tra{\De}{x}{i}}
\end{prooftree}
So $\b = i$.
We have $\subs{\e}{\phi} = \phi(x)$ and $\E$ shows \ev{\phi(x)}{\c}.
By Lemma~\ref{lem:value-eval} and Lemma~\ref{lem:determ} combined we get $\c = \phi(x)$.
Now by Lemma~\ref{lem:left-to-right-var} on $\Tv$ and $\D$, we get derivations $\Bv$ of \hevv{\sg}{i}{\v'} and $\C'$ of $\cor{\v'}{\phi(x)}$ (for some $\v'$).

Taking $\v = \v'$, we construct the required $\B$ as follows and take $\C = \C'$:
\begin{prooftree}
  \prem{\Bv}{\hevv{\sg}{i}{\v'}}
  \uinf{\hev{\sg}{i}{\v'}}
\end{prooftree}

\paragraph{Case $\e = \lam{x}{\e_1}$}

$\T$ must have the form
\begin{prooftree}
	\prem{\T_1}{\tra{\De, x}{\e_1}{\b_1}}
  \uinf{\tra{\De}{\lam{x}{\e_1}}{\lam{}{\b_1}}}
\end{prooftree}
So $\b = \lam{}{\b_1}$. We have $\subs{\e}{\phi} = \subs{(\lam{x}{\e_1})}{\phi} = \lam{x}{\subs{\e_1}{\phi \wo x}}$, so $\E$ must end in \rule{E-Lam} and $v = \lam{x}{\subs{\e_1}{\phi \wo x}}$.
Taking $\v = \cl{\sg}{\b_1}$, we get the required $\B$ showing $\hev{\sg}{\lam{}{\b_1}}{\cl{\sg}{\b_1}}$ by rule \rule{B-Lam}.
And we construct the required derivation $\C$ as follows:
\begin{prooftree}
  \prem{\D}{\comp{\sg}{\De}{\phi}}
  \prem{\T_1}{\tra{\De, x}{\e_1}{\b_1}}
  \binf{\cor{\cl{\sg}{\b_1}}{\lam{x}{\subs{\e_1}{\phi \wo x}}}}
\end{prooftree}

\paragraph{Case $\e = \e_1 \app \e_2$}

$\T$ must have the form
\begin{prooftree}
  \prem{\T_1}{\tra{\De}{\e_1}{\b_1}}
  \prem{\T_2}{\tra{\De}{\e_2}{\b_2}}
  \binf{\tra{\De}{\e_1 \app \e_2}{\b_1 \app \b_2}}
\end{prooftree}
So $\b = \b_1 \app \b_2$.

We have $\subs{\e}{\phi} = \subs{\e_1}{\phi} \app \subs{\e_2}{\phi}$, so $\E$ must end in \rule{E-App} and have the form
\begin{prooftree}
  \prem{\E_1}{\ev{\subs{\e_1}{\phi}}{\lam{x}{\e_0}}}
  \prem{\E_2}{\ev{\subs{\e_2}{\phi}}{\c_2}}
  \prem{\E_3}{\ev{\sub{\e_0}{\c_2}{x}}{\c}}
  \tinf{\ev{\subs{\e_1}{\phi} \app \subs{\e_2}{\phi}}{\c}}
\end{prooftree}

By IH on $\E_1$ with $\T_1$ and $\D$, we get derivations $\B_1$ of \hev{\sg}{\b_1}{\v_1} and $\C_1$ of \cor{\v_1}{\lam{x}{\e_0}} (for some $\v_1$).
$\C_1$ must have the form
\begin{prooftree}
  \prem{\D_1'}{\comp{\sg'}{\De'}{\phi'}}
  \prem{\T_1'}{\tra{\De', x}{\e_0'}{\b_0}}
  \binf{\cor{\cl{\sg'}{\b_0}}{\lam{x}{\subs{\e_0'}{\phi' \wo x}}}}
\end{prooftree}
So $\e_0 = \subs{\e_0'}{\phi' \wo x}$ and $\v_1 = \cl{\sg'}{\b_0}$.

By IH on $\E_2$ with $\T_2$ and $\D$, we get derivations $\B_2$ of \hev{\sg}{\b_2}{\v_2} and $\C_2$ of \cor{\v_2}{\c_2}.
We have $\sub{\subs{\e_0'}{\phi' \wo x}}{\c_2}{x} = \subs{\e_0'}{\phi'[x \mapsto \c_2]}$.
In particular, $\E_3$ shows \ev{\subs{\e_0'}{\phi'[x \mapsto \c_2]}}{\c}.
We construct the following derivation $\D'$ of $\comp{\sg', \v_2}{\De', x}{\phi'[x \mapsto \c_2]}$:
\begin{prooftree}
  \prem{\D_1'}{\comp{\sg'}{\De'}{\phi'}}
  \prem{\C_2}{\cor{\v_2}{\c_2}}
  \binf{\comp{\sg', \v_2}{\De', x}{\phi'[x \mapsto \c_2]}}
\end{prooftree}

Then by IH on $\E_3$ with $\T_1'$ and $\D'$, we get a derivation $\B_3$ of \hev{\sg', \v_2}{\b_0}{\v} along with the required $\C$ showing \cor{\v}{\c}.
And finally we construct the required derivation $\B$ as follows:
\begin{prooftree}
  \prem{\B_1}{\hev{\sg}{\b_1}{\cl{\sg'}{\b_0}}}
  \prem{\B_2}{\hev{\sg}{\b_2}{\v_2}}
  \prem{\B_3}{\hev{\sg', \v_2}{\b_0}{\v}}
  \tinf{\hev{\sg}{\b_1 \app \b_2}{\v}}
\end{prooftree}

\end{proof}

\begin{lemma}
\label{lem:right-to-left-var}
If \trav{\De}{x}{i} (by $\Tv$), \hevv{\sg}{i}{\v} (by $\Bv$) and \comp{\sg}{\De}{\phi} (by $\D$), then $x \in \dom(\phi)$ and \cor{\v}{\phi(x)} (by some $\C$).
\end{lemma}

\begin{proof}
By induction on $\Tv$.

\paragraph{Case \textnormal{\rule{Tv-Here}}}

\begin{prooftree}
  \leftl{$\Tv =$}
  \ax{\trav{\De', x}{x}{\z}}
\end{prooftree}
So $\De = \De', x$ and $i = \z$.
Thus, $\Bv$ has the form
\begin{prooftree}
  \ax{\hevv{\sg', \v}{\z}{\v}}
\end{prooftree}
Hence $\sg = \sg', v$.
Now, given the shape of $\sg$ and $\De$, $\D$ must have the form
\begin{prooftree}
  \prem{\D_1}{\comp{\sg'}{\De'}{\phi'}}
  \prem{\C'}{\cor{\v}{\c}}
  \binf{\comp{\sg', \v}{\De', x}{\phi'[x \mapsto \c]}}
\end{prooftree}
So $\phi = \phi'[x \mapsto \c]$ and consequently $\phi(x) = c$.
In particular, $x \in \dom(\phi)$ and \cor{\v}{c} (taking $\C = \C'$) as required.

\paragraph{Case \textnormal{\rule{Tv-There}}}

\begin{prooftree}
  \prem{\Tv_1}{\trav{\De}{x}{i'}}
  \leftl{$\Tv =$}
	\rightl{$(x \neq y)$}
  \uinf{\trav{\De', y}{x}{\suc i'}}
\end{prooftree}
So $\De = \De', y$ and $i = \suc i'$.
Thus, $\Bv$ has the form
\begin{prooftree}
  \prem{\Bv_1}{\hevv{\sg'}{i}{\v}}
  \uinf{\hevv{\sg', \v'}{\suc i}{\v}}
\end{prooftree}
Hence $\sg = \sg', v'$.

Now, given the shape of $\sg$ and $\De$, $\D$ must have the form
\begin{prooftree}
  \prem{\D_1}{\comp{\sg'}{\De'}{\phi'}}
  \prem{\C'}{\cor{\v'}{\c'}}
  \binf{\comp{\sg', \v'}{\De', y}{\phi'[y \mapsto \c']}}
\end{prooftree}
So $\phi = \phi'[y \mapsto \c']$.

Now by IH on $\Tv_1$ with $\Bv_1$ and $\D_1$, we get $x \in \dom(\phi')$ and a derivation $\C_1$ of $\cor{\v}{\phi'(x)}$.
Since $x \neq y$ we have $\phi(x) = \phi'(x)$.
Thus, $x \in \dom(\phi')$ and we can take $\C = \C_1$ to complete the proof.

\end{proof}

\begin{lemma}
\label{lem:right-to-left}
If \tra{\De}{\e}{\b} (by $\T$), \hev{\sg}{\b}{\v} (by $\B$) and \comp{\sg}{\De}{\phi} (by $\D$), then there exists $\c$ such that \ev{\subs{\e}{\phi}}{\c} (by some $\E$) and \cor{\v}{\c} (by some $\C$).
\end{lemma}

\begin{proof}
By induction on $\B$.

\paragraph{Case \textnormal{\rule{B-Num}}}

\begin{prooftree}
  \leftl{$\B =$}
  \ax{\hev{\sg}{\n{n}}{\n{n}}}
\end{prooftree}
So $\b = \v = \n{n}$.

$\T$ must end in \rule{T-Num} and so $\e = \n{n}$.
Since $\subs{\e}{\phi} = \n{n}$, we can take $\c = \n{n}$ and get the required derivation $\E$ of $\ev{\n{n}}{\n{n}}$ by rule \rule{E-Num}.
And $\cor{\n{n}}{\n{n}}$ by rule \rule{C-Num}.

\paragraph{Case \textnormal{\rule{B-Var}}}

\begin{prooftree}
  \prem{\Bv}{\hevv{\sg}{i}{\v}}
  \leftl{$\B =$}
  \uinf{\hev{\sg}{i}{\v}}
\end{prooftree}
So $\b = i$, and $\T$ must have the form
\begin{prooftree}
  \prem{\Tv}{\trav{\De}{x}{i}}
  \uinf{\tra{\De}{x}{i}}
\end{prooftree}
So $\e = x$.
By Lemma~\ref{lem:right-to-left-var} on $\Tv$, $\Bv$ and $\D$, we get $x \in \dom(\phi)$ and a derivation $\C'$ of $\cor{\v}{\phi(x)}$.
We then have $\subs{\e}{\phi} = \phi(x)$, which by definition is a canonical form.
Taking $\c = \phi(x)$, we get a suitable derivation $\E$ of $\ev{\phi(x)}{\phi(x)}$ by Lemma~\ref{lem:value-eval}.
And we can take $\C = \C'$.

\paragraph{Case \textnormal{\rule{B-Lam}}}

\begin{prooftree}
  \leftl{$\B =$}
  \ax{\hev{\sg}{\lam{}{\b_1}}{\cl{\sg}{\b_1}}}
\end{prooftree}
So $\b = \lam{}{\b_1}$ and $\v = \cl{\sg}{\b_1}$.
$\T$ must have the form
\begin{prooftree}
	\prem{\T_1}{\tra{\De, x}{\e_1}{\b_1}}
  \uinf{\tra{\De}{\lam{x}{\e_1}}{\lam{}{\b_1}}}
\end{prooftree}
So $\e = \lam{x}{\e_1}$.
We have $\subs{\e}{\phi} = \subs{(\lam{x}{\e_1})}{\phi} = \lam{x}{\subs{\e_1}{\phi \wo x}}$, and taking $\c = \lam{x}{\subs{\e_1}{\phi \wo x}}$ we get the required $\E$ showing $\ev{\lam{x}{\subs{\e_1}{\phi \wo x}}}{\lam{x}{\subs{\e_1}{\phi \wo x}}}$ by rule \rule{E-Lam}.
We then construct the required $\C$ using rule \rule{C-Fun} as follows:
\begin{prooftree}
  \prem{\D}{\comp{\sg}{\De}{\phi}}
  \prem{\T_1}{\tra{\De, x}{\e_1}{\b_1}}
  \binf{\cor{\cl{\sg}{\b_1}}{\lam{x}{\subs{\e_1}{\phi \wo x}}}}
\end{prooftree}

\paragraph{Case \textnormal{\rule{B-App}}}

\begin{prooftree}
  \prem{\B_1}{\hev{\sg}{\b_1}{\cl{\sg'}{\b_0}}}
  \prem{\B_2}{\hev{\sg}{\b_2}{\v_2}}
  \prem{\B_3}{\hev{\sg', \v_2}{\b_0}{\v}}
  \leftl{$\B =$}
  \tinf{\hev{\sg}{\b_1 \app \b_2}{\v}}
\end{prooftree}
So $\b = \b_1 \app \b_2$.
$\T$ must have the form
\begin{prooftree}
  \prem{\T_1}{\tra{\De}{\e_1}{\b_1}}
  \prem{\T_2}{\tra{\De}{\e_2}{\b_2}}
  \binf{\tra{\De}{\e_1 \app \e_2}{\b_1 \app \b_2}}
\end{prooftree}
So $\e = \e_1 \app \e_2$.

By IH on $\B_1$ with $\T_1$ and $\D$, we get derivations $\E_1$ of \ev{\subs{\e_1}{\phi}}{\c_1} and $\C_1$ of \cor{\cl{\sg'}{\b_0}}{\c_1} (for some $\c_1$).
$\C_1$ must have the form
\begin{prooftree}
  \prem{\D_1'}{\comp{\sg'}{\De'}{\phi'}}
  \prem{\T_1'}{\tra{\De', x}{\e_0'}{\b_0}}
  \binf{\cor{\cl{\sg'}{\b_0}}{\lam{x}{\subs{\e_0'}{\phi' \wo x}}}}
\end{prooftree}
So $\c_1 = \lam{x}{\subs{\e_0'}{\phi' \wo x}}$.

By IH on $\B_2$ with $\T_2$ and $\D$, we get derivations $\E_2$ of \ev{\subs{\e_2}{\phi}}{\c_2} and $\C_2$ of \cor{\v_2}{\c_2}.
We construct the following derivation $\D'$ of $\comp{\sg', \v_2}{\De', x}{\phi'[x \mapsto \c_2]}$:
\begin{prooftree}
  \prem{\D_1'}{\comp{\sg'}{\De'}{\phi'}}
  \prem{\C_2}{\cor{\v_2}{\c_2}}
  \binf{\comp{\sg', \v_2}{\De', x}{\phi'[x \mapsto \c_2]}}
\end{prooftree}

Then by IH on $\B_3$ with $\T_1'$ and $\D'$, we get a derivation $\E_3$ of \mbox{\ev{\subs{\e_0'}{\phi'[x \mapsto \c_2]}}{\c}} along with the required $\C$ showing \cor{\v}{\c}.
We have $\subs{\e_0'}{\phi'[x \mapsto \c_2]} = \sub{\subs{\e_0'}{\phi' \wo x}}{\c_2}{x}$, in particular $\E_3$ shows \ev{\sub{\subs{\e_0'}{\phi' \wo x}}{\c_2}{x}}{\c}.
And finally, noting $\subs{\e}{\phi} = \subs{\e_1}{\phi} \app \subs{\e_2}{\phi}$, we construct the required derivation $\E$ as follows:
\begin{prooftree}
  \prem{\E_1}{\ev{\subs{\e_1}{\phi}}{\lam{x}{\subs{\e_0'}{\phi' \wo x}}}}
  \prem{\E_2}{\ev{\subs{\e_2}{\phi}}{\c_2}}
  \prem{\E_3}{\ev{\sub{\subs{\e_0'}{\phi' \wo x}}{\c_2}{x}}{\c}}
  \tinf{\ev{\subs{\e_1}{\phi} \app \subs{\e_2}{\phi}}{\c}}
\end{prooftree}

\end{proof}

We can now establish the main theorem.

\begin{proof}[Proof of Theorem~\ref{thm:soundness}]
Supposing \tra{\nil}{\e}{\b} (by $\T$), we show the bi-implication.
For the left-to-right direction, assume \ev{\e}{\n{n}} (by $\E$) and note $\e = \subs{\e}{\nil}$.
Rule \rule{D-Nil} provides $\D$ showing the compatibility of empty contexts.
Then use Lemma~\ref{lem:left-to-right} on $\T$, $\E$ and $\D$ to get \hev{\nil}{\b}{\v} for some $\v$ satisfying \cor{\v}{\n{n}}.
But since numbers correspond only to themselves, we must have $\v = \n{n}$ as required.

The other direction is analogous, using Lemma~\ref{lem:right-to-left} instead.
\end{proof}

\subsection*{A Stack Machine}
We now develop the next translation target, a stack-based language.
\begin{align*}
  \s &\defi \n{n} \alt i \alt \lam{}{\ss_1} \alt \sapp \\
  \ss &\defi \nil \alt \s, \ss
\end{align*}
(Note that $i$ was defined previously.)

We translate from De Bruijn expressions to stack programs using the following judgement --- where $\circ$ denotes concatenation of programs.

\vspace{0.5cm}

\noindent \judgement{\tr{\b}{\ss}}

\begin{prooftree}
  \leftl{\rule{T-Num} :}
  \ax{\tr{\n{n}}{\n{n}, \nil}}
\end{prooftree}

\begin{prooftree}
  \leftl{\rule{T-Var} :}
  \ax{\tr{i}{i, \nil}}
\end{prooftree}

\begin{prooftree}
  \ninf{\tr{\b_1}{\ss_1}}
  \leftl{\rule{T-Lam} :}
  \uinf{\tr{\lam{}{\b_1}}{(\lam{}{\ss_1}), .}}
\end{prooftree}

\begin{prooftree}
  \ninf{\tr{\b_1}{\ss_1}}
  \ninf{\tr{\b_2}{\ss_2}}
  \leftl{\rule{T-App} :}
  \binf{\tr{\b_1 \app \b_2}{\ss_1 \circ \ss_2 \circ (\sapp, \nil)}}
\end{prooftree}

\vspace{0.5cm}

The semantics of the stack language is given as follows:

\begin{align*}
  \w &\defi \n{n} \alt \cl{\tau}{\ss} \\
  \tau &\defi \nil \alt \tau, \w \\
  \Xi &\defi \nil \alt \Xi, \fr{\tau}{\ss} \\
  \Psi &\defi \nil \alt \Psi, \w \\
\end{align*}

\noindent \judgement{\ev{\ss}{\w}}

\begin{prooftree}
  \ninf{\ssev{\fr{\nil}{\ss}}{\nil}{\nil}{\w}}
  \uinf{\ev{\ss}{\w}}
\end{prooftree}

\noindent \judgement{\sevv{\tau}{i}{\w}}

\begin{prooftree}
  \leftl{\rule{Sv-Here} :}
  \ax{\sevv{\tau, \w}{\z}{\w}}
\end{prooftree}

\begin{prooftree}
  \ninf{\sevv{\tau}{i}{\w}}
  \leftl{\rule{Sv-There} :}
  \uinf{\sevv{\tau, \w'}{\suc i}{\w}}
\end{prooftree}

\noindent \judgement{\sev{\Xi}{\Psi}{\Xi'}{\Psi'}}

\begin{prooftree}
  \leftl{\rule{S-Num} :}
  \ax{\sev{\Xi, \fr{\tau}{\n{n}, \ss}}{\Psi}{\Xi, \fr{\tau}{\ss}}{\Psi, \n{n}}}
\end{prooftree}

\begin{prooftree}
  \ninf{\sevv{\tau}{i}{\w}}
  \leftl{\rule{S-Var} :}
  \uinf{\sev{\Xi, \fr{\tau}{i, \ss}}{\Psi}{\Xi, \fr{\tau}{\ss}}{\Psi, \w}}
\end{prooftree}

\begin{prooftree}
  \leftl{\rule{S-Lam} :}
  \ax{\sev{\Xi, \fr{\tau}{(\lam{}{\ss_1}), \ss}}{\Psi}{\Xi, \fr{\tau}{\ss}}{\Psi, \cl{\tau}{\ss_1}}}
\end{prooftree}

\begin{prooftree}
  \leftl{\rule{S-App} :}
  \ax{\sev{\Xi, \fr{\tau}{\sapp, \ss}}{\Psi, \cl{\tau'}{\ss_1}, \w_2}{\Xi, \fr{\tau}{\ss}, \fr{\tau', \w_2}{\ss_1}}{\Psi}}
\end{prooftree}

\begin{prooftree}
  \leftl{\rule{S-Ret} :}
  \ax{\sev{\Xi, \fr{\tau}{\nil}}{\Psi}{\Xi}{\Psi}}
\end{prooftree}

\noindent \judgement{\ssev{\Xi}{\Psi}{\Xi'}{\Psi'}}

\begin{prooftree}
  \leftl{\rule{SS-Zero} :}
  \ax{\ssev{\Xi}{\Psi}{\Xi}{\Psi}}
\end{prooftree}

\begin{prooftree}
  \ninf{\sev{\Xi}{\Psi}{\Xi''}{\Psi''}}
  \ninf{\ssev{\Xi''}{\Psi''}{\Xi'}{\Psi'}}
  \leftl{\rule{SS-More} :}
  \binf{\ssev{\Xi}{\Psi}{\Xi'}{\Psi'}}
\end{prooftree}

\begin{theorem}
If \tr{\b}{\ss}, then \hev{\nil}{\b}{\n{n}} if and only if \ev{\ss}{\n{n}}.
\end{theorem}

To prove this we need two additional judgements:
\vspace{0.5cm}

\noindent \judgement{\cor{\v}{\w}}

\begin{prooftree}
  \leftl{\rule{C-Num} :}
  \ax{\cor{\n{n}}{\n{n}}}
\end{prooftree}

\begin{prooftree}
  \ninf{\cor{\sg}{\tau}}
  \ninf{\tr{\b}{\ss}}
  \leftl{\rule{C-Fun} :}
  \binf{\cor{\cl{\sg}{\b}}{\cl{\tau}{\ss}}}
\end{prooftree}

\noindent \judgement{\scomp{\sg}{\tau}}

\begin{prooftree}
  \leftl{\rule{D-Nil} :}
  \ax{\scomp{\nil}{\nil}}
\end{prooftree}

\begin{prooftree}
  \ninf{\scomp{\sg}{\tau}}
  \ninf{\cor{\v}{\w}}
  \leftl{\rule{D-Cons} :}
  \binf{\scomp{\sg, \v}{\tau, \w}}
\end{prooftree}

\begin{lemma}
If \tr{\b}{\ss_1} and \hev{\sg}{\b}{\v} with \cor{\sg}{\tau}, then (for all $\Xi$, $\Psi$ and $\ss_2$) there exists $\w$ such that \ssev{\Xi, \fr{\tau}{\ss_1 \circ \ss_2}}{\Psi}{\Xi, \fr{\tau}{\ss_2}}{\Psi, \w} with \cor{\v}{\w}.
\end{lemma}

Let $\prec$ denote the standard subterm order on step sequences, i.e. $\P_1 \prec \P_2$ if $\P_1$ is a proper subterm of $\P_2$.

\begin{lemma}
If \tr{\b}{\ss_1} and \ssev{\Xi, \fr{\tau}{\ss_1 \circ \ss_2}}{\Psi}{\nil}{\nil, \w'} (by $\P$) with \cor{\sg}{\tau}, then there exists $\v$ such that \hev{\sg}{\b}{\v} with \cor{\v}{\w} and \ssev{\Xi, \fr{\tau}{\ss_2}}{\Psi, \w}{\nil}{\nil, \w'} (by $\P'$) where $\P' \prec \P$.
\end{lemma}

\end{document}
