\subsection*{Translation}

% filinski: will need more textual explaination

% We define the type of correspondence contexts $\hbctx$.

% \begin{align*}
%   \hbctx &\defi \ctxnil \alt \hbctx_1 \ctxcons \cor{\bval}{\var}
% \end{align*}

\judgement{\trahb{\hbctx}{\benv}{\bexp}{\hexp}}

% explain why it is going in the 'wrong' direction

\begin{prooftree}
  \leftl{\rule{T-Num} :}
  \ax{\trahb{\hbctx}{\benv}{\n{\nat}}{\n{\nat}}}
\end{prooftree}

\begin{prooftree}
  \ninf{\blook{\benv}{\bvar}{\bval}}
  \ninf{\corhb{\hbctx}{\bval}{\hexp}}
  \leftl{\rule{T-Var} :}
  \binf{\trahb{\hbctx}{\benv}{\bvar}{\hexp}}
\end{prooftree}

\begin{prooftree}
	\ninf{\trahb{\hbctx}{\benv \envcons \var}{\bexp_1}{\hexp_1}}
  \rightl{($\var \notin \benv$)}
  \leftl{\rule{T-Lam} :}
  \uinf{\trahb{\hbctx}{\benv}{\blam{\bexp_1}}{\lam{\var}{\hexp_1}}}
\end{prooftree}

\begin{prooftree}
  \ninf{\trahb{\hbctx}{\benv}{\bexp_1}{\hexp_1}}
  \ninf{\trahb{\hbctx}{\benv}{\bexp_2}{\hexp_2}}
	\leftl{\rule{T-App} :}
  \binf{\trahb{\hbctx}{\benv}{\bapp{\bexp_1}{\bexp_2}}{\app{\hexp_1}{\hexp_2}}}
\end{prooftree}

\begin{prooftree}
  \ninf{\trahb{\hbctx}{\benv}{\bexp_1}{\hexp_1}}
	\leftl{\rule{T-Suc} :}
  \uinf{\trahb{\hbctx}{\benv}{\bsuc{\bexp_1}}{\hsuc{\hexp_1}}}
\end{prooftree}

% \begin{prooftree}
% 	\ninf{\trahb{\hbctx}{\benv}{b_1}{e_1}}
% 	\ninf{\trahb{\hbctx}{\benv}{b_2}{e_2}}
% 	\ninf{\trahb{\hbctx, \cor{\bval}{x}}{\benv, \bval}{b_3}{e_3}}
%   \leftl{\rule{T-Case} :}
%   \rightl{$(\forall \bval' . \; (\cor{\bval'}{x}) \notin \hbctx)$}
%   \tinf{\trahb{\hbctx}{\benv}{\bcase{b_1}{b_2}{b_3}}{\hcase{e_1}{e_2}{e_3}}}
% \end{prooftree}

We define a correspondence between values and expressions in canonical form:

\vspace{0.5cm}

\judgement{\corhb{\hbctx}{\bval}{\hexp}}

\begin{prooftree}
  \leftl{\rule{C-Var} :}
  \ax{\corhb{\Theta}{\var}{\var}}
\end{prooftree}

\begin{prooftree}
  \leftl{\rule{C-Num} :}
  \ax{\corhb{\hbctx}{\n{\nat}}{\n{\nat}}}
\end{prooftree}

\begin{prooftree}
  \ninf{\trahb{\hbctx}{\benv}{\blam{\bexp}}{\lam{\var}{\hexp}}}
  \leftl{\rule{C-Fun} :}
  \uinf{\corhb{\hbctx}{\cl{\benv}{\bexp}}{\lam{\var}{\hexp}}}
\end{prooftree}

It is not immediately clear that this translation is total in the right-to-left direction, i.e. that every $\hexp$ has a corresponding $\bexp$.
In fact, this property does not hold!
Consider $\hexp = \lam{\var}{\lam{\var}{\n{0}}}$; the best attempt at a translation would be the following:
\begin{prooftree}
	\ax{\trahb{\hbctx}{\envnil \envcons \var \envcons \var}{\n{0}}{\n{0}}}
  \rightl{($\var \notin (\envnil \envcons \var)$)}
  \uinf{\trahb{\hbctx}{\envnil \envcons \var}{\blam{\n{0}}}{\lam{\var}{\n{0}}}}
  \rightl{($\var \notin \envnil$)}
  \uinf{\trahb{\hbctx}{\envnil}{\blam{\blam{\n{0}}}}{\lam{\var}{\lam{\var}{\n{0}}}}}
\end{prooftree}
However, the side condition $\var \notin (\envnil \envcons \var)$ is blatantly false. In general, nested $\lambda$'s using the same variable name will run into this problem.

Hence, we can at best hope that there is always some alpha-equivalent program which is translatable.
Even this is not readily apparent from the rules and therefore requires a proof.

\begin{theorem}[Totality]
For any $\hexp$ there exists an alpha-equivalent $\hexp'$ and some $\bexp$ such that \trahb{\hbctx}{\envnil}{\bexp}{\hexp'}.
\end{theorem}

This is proven by the following generalised statement.

\begin{lemma}[Totality]
For any $\hexp$ and $\benv$ with free variables $\var_1, \ldots, \var_n$ together with indices $\bvar_1, \ldots, \bvar_n$ and derivations $\Tv_1, \ldots, \Tv_n$ of respectively $\blook{\benv}{\bvar_1}{\var_1}, \ldots, \blook{\benv}{\bvar_n}{\var_n}$ there exists an alpha-equivalent $\hexp'$ such that \trahb{\hbctx}{\benv}{\bexp}{\hexp'} (by some $\T$) for some $\bexp$.
\end{lemma}

\begin{proof}
By induction on $\hexp$ modulo renaming, i.e. if $\hexp_1$ is a subterm of $\hexp$ then $\sub{\hexp_1}{\var}{\othervar}$ is also considered a subterm.
Since in any case the size of the term decreases the induction is well-founded.

\paragraph{Case $\hexp = \var$}
Since $\var$ is free we must have $\var = \var_k$ for some $k$.
Take $\hexp' = \hexp$ and let $\T$ be
\begin{prooftree}
  \prem{\Tv_k}{\blook{\benv}{\bvar_k}{\var_k}}
  \ax{\corhb{\hbctx}{\var_k}{\var_k}}
  \binf{\trahb{\hbctx}{\benv}{\bvar_k}{\var_k}}
\end{prooftree}

\paragraph{Case $\hexp = \lam{\var}{\hexp_1}$}
\paragraph{Subcase \textnormal{$\var = \var_k$ for some $k$}}
Let $\othervar$ be a variable that does not occur free in $\hexp_1$ and let $\hexp_1' = \sub{\hexp_1}{\othervar}{\var}$.
We want to invoke the IH with $\hexp_1'$ and $\benv \envcons \othervar$, which requires suitable derivations.
Let $\Tv_k'$ be
\begin{prooftree}
  \ax{\blook{\benv \envcons \othervar}{\z}{\othervar}}
\end{prooftree}
and for any $j \neq k$ let $\Tv_j'$ be
\begin{prooftree}
  \prem{\Tv_j}{\blook{\benv}{\bvar_j}{\var_j}}
  \uinf{\blook{\benv \envcons \othervar}{\suc{\bvar_j}}{\var_j}}
\end{prooftree}
By IH on $\hexp_1'$ with $\benv \envcons \othervar$ and $\Tv_1', \ldots, \Tv_n'$ we get \trahb{\hbctx}{\benv \envcons \othervar}{\bexp_1}{\hexp_1''} (by some $\T_1$) for some $\bexp_1$ and $\hexp_1''$.
Observing that $\lam{\var}{\hexp_1}$ is alpha-equivalent to $\lam{\othervar}{\sub{\hexp_1}{\othervar}{\var}}$ which is again alpha-equivalent to $\lam{\othervar}{\hexp_1''}$ we can take $\T$ to be

\begin{prooftree}
	\prem{\T_1}{\trahb{\hbctx}{\benv \envcons \othervar}{\bexp_1}{\hexp_1''}}
  \rightl{($\othervar \notin \benv$)}
  \uinf{\trahb{\hbctx}{\benv}{\blam{\bexp_1}}{\lam{\othervar}{\hexp_1''}}}
\end{prooftree}

\paragraph{Subcase \textnormal{$\var \neq \var_k$ for all $k$}}
For all $j$ let $\Tv_j'$ be
\begin{prooftree}
  \prem{\Tv_j}{\blook{\benv}{\bvar_j}{\var_j}}
  \uinf{\blook{\benv \envcons \var}{\suc{\bvar_j}}{\var_j}}
\end{prooftree}
By IH on $\hexp_1$ with $\benv \envcons \var$ and $\Tv_1', \ldots, \Tv_n'$ we get \trahb{\hbctx}{\benv \envcons \var}{\bexp_1}{\hexp_1'} (by some $\T_1$) for some $\bexp_1$ and $\hexp_1'$.
Since $\lam{\var}{\hexp_1}$ is alpha-equivalent to $\lam{\var}{\hexp_1'}$ we can $\T$ to be
\begin{prooftree}
	\prem{\T_1}{\trahb{\hbctx}{\benv \envcons \var}{\bexp_1}{\hexp_1'}}
  \rightl{($\var \notin \benv$)}
  \uinf{\trahb{\hbctx}{\benv}{\blam{\bexp_1}}{\lam{\othervar}{\hexp_1'}}}
\end{prooftree}

\end{proof}
