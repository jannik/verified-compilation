\subsection{Preservation}

We want to show that if \trahb{\hbctx}{\envnil}{\bexp}{\hexp}, then \hev{\hexp}{\n{\nat}} if and only if \bev{\envnil}{\bexp}{\n{\nat}}.
To prove this, we need an assortment of lemmas.
First some facts about substitution.

\begin{lemma}[Shadowing]
\label{lem:shadowing}
If \trahb{\hbctx}{\benvext \envcons \var}{\bexp}{\hexp} (by $\T$) then \trahb{\hbctx}{\sub{\benvext}{\bval}{\var} \envcons \var}{\bexp}{\hexp}.
\end{lemma}

\begin{proof}
Straighforward induction on $\T$, suitably appealing to the side condition in \rulename{Tv-There}.
\end{proof}

\begin{lemma}[Correspondence Substitution]
\label{lem:substitution-cor}
If \corhb{\hbxtx}{\bvalext}{\hexp} (by $\C$) and \corhb{\hbctx}{\bval'}{\hexp'} (by $\C'$) then \corhb{\hbctx}{\sub{\bvalext}{\bval'}{\var}}{\sub{\hexp}{\hexp'}{\var}} (by some $\C''$).
\end{lemma}

\begin{proof}
Straightforward induction on $\C$.
% Or is it?
\end{proof}

\begin{lemma}[Lookup Substitution]
\label{lem:substitution-lookup}
Given $\var$ and $\bval$, if \blook{\benv}{\bvar}{\bval'} (by $\Tv$) then \blook{\sub{\benv}{\bval}{\var}}{\bvar}{\sub{\bval'}{\bval}{\var}}.
\end{lemma}

\begin{proof}
Straightforward induction on $\Tv$.
\end{proof}

\begin{lemma}[Translation Substitution]
\label{lem:substitution-trans}
If \trahb{\hbctx}{\benvext}{\bexp}{\hexp} (by $\T$) and \corhb{\hbctx}{\bval}{\hval} (by $\C$) then \trahb{\hbctx}{\sub{\benvext}{\bval}{\var}}{\bexp}{\sub{\hexp}{\hval}{\var}} (by some $\T'$).
\end{lemma}

\begin{proof}
By induction on $\T$.
We show only the cases dealing with variables.

\paragraph{Case \textnormal{\rulename{T-Var}}}

$\T$ has the form
\begin{prooftree}
  \prem{\Tv}{\blookext{\benvext}{\bvar}{\bval'}}
  \prem{\C_1}{\corhb{\hbctx}{\bval'}{\hexp}}
  \binf{\trahb{\hbctx}{\benvext}{\bvar}{\hexp}}
\end{prooftree}
By Lemma~\ref{lem:substitution-lookup} on $\Tv$ we get \blookext{\sub{\benvext}{\bval}{\var}}{\bvar}{\sub{\bval'}{\bval}{\var}} (by $\Tv'$).
By Lemma~\ref{lem:substitution-cor} on $\C_1$ with $\C$ we get \corhb{\hbctx}{\sub{\bval'}{\bval}{\var}}{\sub{\hexp}{\hval}{\var}} (by $\C_1'$).
Hence, we can take $\T'$ to be
\begin{prooftree}
  \prem{\Tv'}{\blookext{\sub{\benvext}{\bval}{\var}}{\bvar}{\sub{\bval'}{\bval}{\var}}}
  \prem{\C_1'}{\corhb{\hbctx}{\sub{\bval'}{\bval}{\var}}{\sub{\hexp}{\hval}{\var}}}
  \binf{\trahb{\hbctx}{\sub{\benvext}{\bval}{\var}}{\bvar}{\sub{\hexp}{\hval}{\var}}}
\end{prooftree}




\paragraph{Case \textnormal{\rulename{T-Lam}}}
$\T$ has the form
\begin{prooftree}
	\prem{\T_1}{\trahb{\hbctx}{\benvext \envcons \othervar}{\bexp_1}{\hexp_1}}
  \uinf{\trahb{\hbctx}{\benvext}{\blam{\bexp_1}}{\lam{\othervar}{\hexp_1}}}
\end{prooftree}
If $\var = \othervar$ then $\sub{(\benvext \envcons \othervar)}{\bval}{\var} = \sub{\benvext}{\bval}{\var} \envcons \bval$ and $\sub{(\lam{\othervar}{\hexp_1})}{\hval}{\var} = \lam{\othervar}{\hexp_1}$ and we use Lemma~\ref{lem:shadowing} on $\T_1$ to get \trahb{\hbctx}{\sub{\benvext}{\bval}{\var} \envcons \othervar}{\bexp_1}{\hexp_1} (by some $\T_1'$).
Using \rulename{T-Lam} with $\T_1'$ provides the required $\T'$.

Otherwise $x \neq y$ so $\sub{(\benvext \envcons \othervar)}{\bval}{\var} = \sub{\benvext}{\bval}{\var} \envcons \othervar$ and $\sub{(\lam{\othervar}{\hexp_1})}{\hval}{\var} = \lam{\othervar}{\sub{\hexp_1}{\hval}{\var}}$.
By IH on $\T_1$ with $\C$ we get \trahb{\hbctx}{\sub{\benvext}{\bval}{\var} \envcons \othervar}{\bexp_1}{\sub{\hexp_1}{\hval}{\var}} (by $\T_1'$) which has the right shape to finish the case with \rulename{T-Lam}.

\end{proof}

\Twelf
This lemma, like any substitution lemma, comes ``for free'' since all definitions in Twelf respect substitution by construction.


\begin{lemma}[Soundness]
\label{lem:soundness-hb}
For closed $\hexp$, if \trahb{\hbctx}{\benv}{\hexp}{\bexp} (by $\T$) and \bev{\benv}{\bexp}{\bval} (by $\B$), then there exists $\hval$ such that \hev{\hexp}{\hval} (by some $\E$) and \corhb{\hbctx}{\bval}{\hval} (by some $\C$).
\end{lemma}

\code{soundness-hb'}{soundness-hoas-bruijn.elf}

\begin{proof}

By induction on $\B$. We proceed by case analysis on $\T$ showing only the interesting cases.

\paragraph{Case \textnormal{\rulename{T-Lam}}}
$\T$ has the form
\begin{prooftree}
	\prem{\T_1}{\trahb{\hbctx}{\benv \ctxcons \var}{\bexp_1}{\hexp_1}}
  \uinf{\trahb{\Theta}{\benv}{\blam{\bexp_1}}{\lam{\var}{\hexp_1}}}
\end{prooftree}
Hence, $\B$ must be
\begin{prooftree}
  \ax{\bev{\benv}{\blam{\bexp_1}}{\cl{\benv}{\bexp_1}}}
\end{prooftree}
Using \rulename{E-Lam} we get \hev{\lam{\var}{\hexp_1}}{\lam{\var}{\hexp_1}} and construct the required correspondence as follows:
\begin{prooftree}
  \prem{\T}{\trahb{\hbctx}{\benv}{\blam{\bexp_1}}{\lam{\var}{\hexp_1}}}
  \uinf{\corhb{\hbctx}{\cl{\benv}{\bexp_1}}{\lam{\var}{\hexp_1}}}
\end{prooftree}


\paragraph{Case \textnormal{\rulename{T-App}}}
$\T$ has the form
\begin{prooftree}
  \prem{\T_1}{\trahb{\hbctx}{\benv}{\bexp_1}{\hexp_1}}
  \prem{\T_2}{\trahb{\hbctx}{\benv}{\bexp_2}{\hexp_2}}
  \binf{\trahb{\hbctx}{\benv}{\bapp{\bexp_1}{\bexp_2}}{\app{\hexp_1}{\hexp_2}}}
\end{prooftree}
Hence, $\B$ must be
\begin{prooftree}
  \prem{\B_1}{\bev{\benv}{\bexp_1}{\cl{\benv'}{\bexp_0}}}
  \prem{\B_2}{\bev{\benv}{\bexp_2}{\bval_2}}
  \prem{\B_3}{\bev{\benv' \ctxcons \bval_2}{\bexp_0}{\bval}}
  \tinf{\bev{\benv}{\bapp{\bexp_1}{\bexp_2}}{\bval}}
\end{prooftree}

By IH on $\B_1$ with $\T_1$ we get \hev{\hexp_1}{\hval_1} by some $\E_1$ and \corhb{\hbctx}{\cl{\benv'}{\bexp_0}}{\hval_1} by some $\C_1$ which must have the shape
\begin{prooftree}
	\prem{\T_3}{\trahb{\hbctx}{\benv \envcons \var}{\bexp_0}{\hexp_0}}
  \uinf{\trahb{\hbctx}{\benv}{\blam{\bexp_0}}{\lam{\var}{\hexp_0}}}
  \uinf{\corhb{\hbctx}{\cl{\benv'}{\bexp_0}}{\lam{\var}{\hexp_0}}}
\end{prooftree}
so $\hval_1 = \lam{\var}{\hexp_0}$.

By IH on $\B_2$ with $\T_2$ we get \hev{\hexp_2}{\hval_2} (by some $\E_2$) and \corhb{\hbctx}{\bval_2}{\hval_2} (by some $\C_2$).
Using Lemma~\ref{lem:substitution-trans} on $\T_3$ with $\C_2$ we get \trahb{\hbctx}{\benv \envcons \bval_2}{\bexp_0}{\sub{\hexp_0}{\hval_2}{\var}} (by some $\T_3'$).
By IH on $\B_3$ with $\T_3'$ we get \hev{\sub{\hexp_0}{\hval_2}{\var}}{\hval} by some $\E_3$ and $\corhb{\hbctx}{\bval}{\hval}$ by some $\C_3$.
The case is finished using \rulename{E-App} with $\E_1$, $\E_2$ and $\E_3$; the required correspondence is provided by $\C_3$.

\end{proof}

\begin{lemma}[Completeness]
\label{lem:completeness-hb}
If \trahb{\hbctx}{\benv}{\hexp}{\bexp} (by $\T$) and \hev{\hexp}{\hval} (by $\E$), then there exists $\bval$ such that \bev{\benv}{\bexp}{\bval} (by some $\B$) and \corhb{\hbctx}{\bval}{\hval} (by some $\C$).
\end{lemma}

\code{completeness-hb'}{completeness-hoas-bruijn.elf}

\begin{proof}
Completely analogous to the soundness proof.
\end{proof}

\Twelf
Note that the implementations of soundness and completeness are identical, safe for the choice of mode and induction variable.

And finally, we can establish the main theorem:

\begin{theorem}[Preservation \textnormal{\hlang-\blang}]
\label{thm:preservation-hb} If \trahb{\hbctx}{\envnil}{\bexp}{\hexp}, then \hev{\hexp}{\n{\nat}} if and only if \bev{\envnil}{\bexp}{\n{\nat}}.
\end{theorem}

\doublecode{soundness-hb}{soundness-hoas-bruijn.elf}{completeness-hb}{completeness-hoas-bruijn.elf}

\Twelf
It is not possible to state the preservation theorem directly in Twelf since it, abstractly speaking, has the form $P \rightarrow ((Q \rightarrow R) \wedge (R \rightarrow Q))$ which is not $\Pi_2^0$.
Proving $P \rightarrow Q \rightarrow R$ and $P \rightarrow R \rightarrow Q$ separately is equivalent, however, so the Twelf proof of preservation is factored into soundness and completeness.

% something about the fact that we cannot state preservation in twelf.
