
\subsection*{Equivalence}

\begin{theorem} [Equivalence Stack-Machine]
\label{thm:equivalence-sm} If $\trasmfinal{\sprog}{\mprog}{\addr}$, then $\sev{\sprog}{\n{\nat}}$ if and only if $\meval{\mprog}{\addr}{\n{\nat}}$.
\end{theorem}

To prove this, we need some correspondence judgements:

\vspace{0.5cm}
\judgement{$\mprog' \leq_{\nat} \mprog$}

\begin{prooftree}
  \leftl{\rule{Leq-Here} :}
  \rightl{$(\text{$\mprog'$ is a prefix of $\mprog$})$}
  \ax{$\mprog' \leq_{0} \mprog$}
\end{prooftree}

\begin{prooftree}
  \leftl{\rule{Leq-There} :}
  \ninf{$\shift{\mprog'}{1} \leq_{n} \mprog$}
  \uinf{$\mprog' \leq_{n + 1} \minst \mseq \mprog$}
\end{prooftree}

\vspace{0.5cm}
\judgement{$\corvalue{\mprog}{\sval}{\mval}$}

\begin{prooftree}
  \leftl{\rule{C-Num} :}
  \ax{$\corvalue{\mprog}{\n{\nat}}{\n{\nat}}$}
\end{prooftree}

\begin{prooftree}
  \ninf{$\corstore{\mprog}{\senv}{\menv}$}
  \ninf{$\trasm{\sprog}{\mprog'}$}
  \ninf{$\mprog' \leq_{\addr} \mprog$}
  \leftl{\rule{C-Clos} :}
  \tinf{$\corvalue{\mprog}{\cl{\senv}{\sprog}}{\cl{\menv}{\addr}}$}
\end{prooftree}

\vspace{0.5cm}
\judgement{$\corstore{\mprog}{\senv}{\menv}$}

\begin{prooftree}
  \leftl{\rule{D-Nil} :}
  \ax{$\corstore{\mprog}{\envnil}{\envnil}$}
\end{prooftree}

\begin{prooftree}
  \ninf{$\corstore{\mprog}{\senv}{\menv}$}
  \ninf{$\corvalue{\mprog}{\sval}{\mval}$}
  \leftl{\rule{D-Cons} :}
  \binf{$\corstore{\mprog}{\senv \envcons \sval}{\menv \envcons \mval}$}
\end{prooftree}

\vspace{0.5cm}
\judgement{$\corvaluestack{\mprog}{\svals}{\mvals}$}
\vspace{0.5cm}

\begin{prooftree}
  %\leftl{\rule{D-Nil} :}
  \ax{$\corvaluestack{\mprog}{\stknil}{\stknil}$}
\end{prooftree}

\begin{prooftree}
  \ninf{$\corvaluestack{\mprog}{\svals}{\mvals}$}
  \ninf{$\corvalue{\mprog}{\sval}{\mval}$}
  %\leftl{\rule{D-Cons} :}
  \binf{$\corvaluestack{\mprog}{\svals \stkcons \sval}{\mvals \stkcons \mval}$}
\end{prooftree}

\vspace{0.5cm}
\judgement{$\corstack{\mprog}{\sctrl}{\addr}{\mctrl}$}

\begin{prooftree}
  \rightl{$(\mprog(\addr) = \mhalt)$}
  \ax{$\corstack{\mprog}{\stknil}{\addr}{\stknil}$}
\end{prooftree}

\begin{prooftree}
  \ninf{$\corstack{\mprog}{\sctrl}{\addr'}{\mctrl}$}
  \ninf{$\corstore{\mprog}{\senv}{\menv}$}
  \ninf{$\trasm{\sprog}{\mprog'}$}
  \ninf{$\mprog' \leq_{\addr} \mprog$}
  \qinf{$\corstack{\mprog}{\sctrl \stkcons \fr{\senv}{\sprog}}{\addr}{\mctrl \stkcons \fr{\menv}{\addr'}}$}
\end{prooftree}

\vspace{0.5cm}

And now we are ready to generalise completeness and soundness:

\begin{lemma}[Completeness]
\label{lem:completeness-sm}
If $\ssteps{\sctrl}{\svals}{\stknil}{[\sval]}$, $\corstack{\mprog}{\sctrl}{\addr}{\mctrl}$ and $\corvaluestack{\mprog}{\svals}{\mvals}$, then there exists $\mval$ such that $\msteps{\mprog}{\mctrl}{\addr}{\mvals}{\stknil}{\addr'}{[\mval]}$ with $\mprog(\addr') = \mhalt$ and $\corvalue{\mprog}{\sval}{\mval}$.
\end{lemma}

\begin{lemma}[Soundness]
\label{lem:soundness-sm}
If $\msteps{\mprog}{\mctrl}{\addr}{\mvals}{\stknil}{\addr'}{[\mval]}$ with $\mprog(\addr') = \mhalt$, $\corstack{\mprog}{\sctrl}{\addr}{\mctrl}$ and $\corvaluestack{\mprog}{\svals}{\mvals}$, then there exists $\sval$ such that $\ssteps{\sctrl}{\svals}{\stknil}{[\sval]}$ with $\corvalue{\mprog}{\sval}{\mval}$.
\end{lemma}
