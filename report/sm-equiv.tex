
\subsection{Equivalence}

We want to show that if $\trasmfinal{\sprog}{\mprog}{\addr}$, then $\sev{\sprog}{\n{\nat}}$ if and only if $\meval{\mprog}{\addr}{\n{\nat}}$.
This poses the problem of how to handle translations of subprograms when the evaluation is happening in the context of the full program.
As a solution we define a subprogram relation that keeps track of the position of the subprogram within the complete program.

\begin{judgement}{$\mprog' \leq_{\nat} \mprog$}

% Sub instead of Leq.
\begin{prooftree}
  \rightl{$(\text{$\mprog'$ is a prefix of $\mprog$})$}
  \ax{$\mprog' \leq_{0} \mprog$}
\end{prooftree}

\begin{prooftree}
  \ninf{$\shift{\mprog'}{1} \leq_{n} \mprog$}
  \uinf{$\mprog' \leq_{n + 1} \minst \mseq \mprog$}
\end{prooftree}

\end{judgement}

We also need some correspondence judgements:

\begin{judgement}{$\corvalue{\mprog}{\sval}{\mval}$}

\begin{prooftree}
  \ax{$\corvalue{\mprog}{\n{\nat}}{\n{\nat}}$}
\end{prooftree}

\begin{prooftree}
  \ninf{$\corstore{\mprog}{\senv}{\menv}$}
  \ninf{$\trasm{\sprog}{\mprog'}$}
  \ninf{$\mprog' \leq_{\addr} \mprog$}
  \tinf{$\corvalue{\mprog}{\cl{\senv}{\sprog}}{\cl{\menv}{\addr}}$}
\end{prooftree}

\end{judgement}

\begin{judgement}{$\corstore{\mprog}{\senv}{\menv}$}

\begin{prooftree}
  \ax{$\corstore{\mprog}{\envnil}{\envnil}$}
\end{prooftree}

\begin{prooftree}
  \ninf{$\corstore{\mprog}{\senv}{\menv}$}
  \ninf{$\corvalue{\mprog}{\sval}{\mval}$}
  \binf{$\corstore{\mprog}{\senv \envcons \sval}{\menv \envcons \mval}$}
\end{prooftree}

\end{judgement}

\begin{judgement}{$\corvaluestack{\mprog}{\svals}{\mvals}$}

\begin{prooftree}
  \ax{$\corvaluestack{\mprog}{\stknil}{\stknil}$}
\end{prooftree}

\begin{prooftree}
  \ninf{$\corvaluestack{\mprog}{\svals}{\mvals}$}
  \ninf{$\corvalue{\mprog}{\sval}{\mval}$}
  \binf{$\corvaluestack{\mprog}{\svals \stkcons \sval}{\mvals \stkcons \mval}$}
\end{prooftree}

\end{judgement}

\begin{judgement}{$\corstack{\mprog}{\sctrl}{\mctrl}{\addr}$}

\begin{prooftree}
  \rightl{$(\mprog(\addr) = \mhalt)$}
  \ax{$\corstack{\mprog}{\stknil}{\stknil}{\addr}$}
\end{prooftree}

\begin{prooftree}
  \ninf{$\corstack{\mprog}{\sctrl}{\mctrl}{\addr'}$}
  \ninf{$\corstore{\mprog}{\senv}{\menv}$}
  \ninf{$\trasm{\sprog}{\mprog'}$}
  \ninf{$\mprog' \leq_{\addr} \mprog$}
  \qinf{$\corstack{\mprog}{\sctrl \stkcons \fr{\senv}{\sprog}}{\mctrl \stkcons \fr{\menv}{\addr'}}{\addr}$}
\end{prooftree}

\end{judgement}

And now we are ready to generalise soundness and completeness:

\begin{lemma}[Soundness]
\label{lem:soundness-sm}
If $\msteps{\mprog}{\mctrl}{\addr}{\mvals}{\stknil}{\addr'}{[\mval]}$ with $\mprog(\addr') = \mhalt$, $\corstack{\mprog}{\sctrl}{\addr}{\mctrl}$ and $\corvaluestack{\mprog}{\svals}{\mvals}$, then there exists $\sval$ such that $\ssteps{\sctrl}{\svals}{\stknil}{[\sval]}$ with $\corvalue{\mprog}{\sval}{\mval}$.
\end{lemma}

\code{soundness-sm'}{soundness-stack-machine.elf}

\begin{lemma}[Completeness]
\label{lem:completeness-sm}
If $\ssteps{\sctrl}{\svals}{\stknil}{[\sval]}$, $\corstack{\mprog}{\sctrl}{\addr}{\mctrl}$ and $\corvaluestack{\mprog}{\svals}{\mvals}$, then there exists $\mval$ such that $\msteps{\mprog}{\mctrl}{\addr}{\mvals}{\stknil}{\addr'}{[\mval]}$ with $\mprog(\addr') = \mhalt$ and $\corvalue{\mprog}{\sval}{\mval}$.
\end{lemma}

\code{completeness-sm'}{completeness-stack-machine.elf}

Finally, we can establish the main theorem:

\begin{theorem}[Equivalence \textnormal{\slang}-\textnormal{\mlang}]
\label{thm:equivalence-sm} If $\trasmfinal{\sprog}{\mprog}{\addr}$, then $\sev{\sprog}{\n{\nat}}$ if and only if $\meval{\mprog}{\addr}{\n{\nat}}$.
\end{theorem}
